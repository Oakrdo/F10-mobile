-- Auto Farm Tennenman, Goku e Carl com Teleport Pr√≥ximo + ESP Esferas do Drag√£o
-- Por: DeepSeek-R1

wait(2)

-- Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local TweenService = game:GetService("TweenService")

-- Vari√°veis
local player = Players.LocalPlayer
local character = player.Character
local humanoid = character and character:WaitForChild("Humanoid")
local rootPart = character and character:WaitForChild("HumanoidRootPart")

-- Configura√ß√µes
local FARM_RANGE = 500
local ATTACK_RANGE = 3
local TELEPORT_OFFSET = 2
local IS_FARMING = false
local IS_ESP_ACTIVE = false
local currentTarget = nil
local targetNPCs = {}
local dragonBalls = {}
local espHandles = {}

-- NPCs para farmar
local NPC_TARGETS = {
    "Tennenman",
    "Goku", 
    "Carl"
}

-- Criar GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoFarmDBR"
screenGui.Parent = player:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false

-- Frame principal
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0.5, 0, 0.3, 0)
mainFrame.Position = UDim2.new(0.05, 0, 0.65, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 30, 30)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

-- T√≠tulo
local title = Instance.new("TextLabel")
title.Text = "üêâ AUTO FARM DBR + ESP ESFERAS"
title.Size = UDim2.new(1, 0, 0.12, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1, 1, 1)
title.TextScaled = true
title.Font = Enum.Font.SourceSansBold
title.Parent = mainFrame

-- Status
local statusLabel = Instance.new("TextLabel")
statusLabel.Text = "üî¥ PARADO"
statusLabel.Size = UDim2.new(1, 0, 0.12, 0)
statusLabel.Position = UDim2.new(0, 0, 0.12, 0)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
statusLabel.TextScaled = true
statusLabel.Parent = mainFrame

-- Info
local infoLabel = Instance.new("TextLabel")
infoLabel.Text = "NPCs: 0 | Alvo: Nenhum"
infoLabel.Size = UDim2.new(1, 0, 0.12, 0)
infoLabel.Position = UDim2.new(0, 0, 0.24, 0)
infoLabel.BackgroundTransparency = 1
infoLabel.TextColor3 = Color3.new(0.8, 0.8, 1)
infoLabel.TextScaled = true
infoLabel.Parent = mainFrame

-- ESP Info
local espInfoLabel = Instance.new("TextLabel")
espInfoLabel.Text = "üåü Esferas: 0"
espInfoLabel.Size = UDim2.new(1, 0, 0.12, 0)
espInfoLabel.Position = UDim2.new(0, 0, 0.36, 0)
espInfoLabel.BackgroundTransparency = 1
espInfoLabel.TextColor3 = Color3.new(1, 1, 0.5)
espInfoLabel.TextScaled = true
espInfoLabel.Parent = mainFrame

-- NPC Info
local npcInfoLabel = Instance.new("TextLabel")
npcInfoLabel.Text = "üéØ: Tennenman | Goku | Carl"
npcInfoLabel.Size = UDim2.new(1, 0, 0.12, 0)
npcInfoLabel.Position = UDim2.new(0, 0, 0.48, 0)
npcInfoLabel.BackgroundTransparency = 1
npcInfoLabel.TextColor3 = Color3.new(0.5, 1, 0.5)
npcInfoLabel.TextScaled = true
npcInfoLabel.Parent = mainFrame

-- Bot√µes
local buttonFrame = Instance.new("Frame")
buttonFrame.Size = UDim2.new(1, 0, 0.4, 0)
buttonFrame.Position = UDim2.new(0, 0, 0.6, 0)
buttonFrame.BackgroundTransparency = 1
buttonFrame.Parent = mainFrame

-- Bot√£o Iniciar/Parar Farm
local toggleButton = Instance.new("TextButton")
toggleButton.Text = "‚ñ∂ INICIAR FARM"
toggleButton.Size = UDim2.new(0.48, 0, 0.4, 0)
toggleButton.Position = UDim2.new(0.01, 0, 0.05, 0)
toggleButton.BackgroundColor3 = Color3.fromRGB(80, 180, 80)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.TextScaled = true
toggleButton.Parent = buttonFrame

-- Bot√£o Procurar NPCs
local searchButton = Instance.new("TextButton")
searchButton.Text = "üîç ATUALIZAR"
searchButton.Size = UDim2.new(0.48, 0, 0.4, 0)
searchButton.Position = UDim2.new(0.51, 0, 0.05, 0)
searchButton.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
searchButton.TextColor3 = Color3.new(1, 1, 1)
searchButton.TextScaled = true
searchButton.Parent = buttonFrame

-- Bot√£o ESP Esferas
local espButton = Instance.new("TextButton")
espButton.Text = "üåü LIGAR ESP"
espButton.Size = UDim2.new(0.48, 0, 0.4, 0)
espButton.Position = UDim2.new(0.01, 0, 0.55, 0)
espButton.BackgroundColor3 = Color3.fromRGB(180, 80, 180)
espButton.TextColor3 = Color3.new(1, 1, 1)
espButton.TextScaled = true
espButton.Parent = buttonFrame

-- Bot√£o Coletar Esferas
local collectButton = Instance.new("TextButton")
collectButton.Text = "üíé COLETAR ESFERAS"
collectButton.Size = UDim2.new(0.48, 0, 0.4, 0)
collectButton.Position = UDim2.new(0.51, 0, 0.55, 0)
collectButton.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
collectButton.TextColor3 = Color3.new(0, 0, 0)
collectButton.TextScaled = true
collectButton.Parent = buttonFrame

-- Fun√ß√£o para atualizar refer√™ncias do personagem
local function updateCharacterReferences()
    character = player.Character
    if character then
        humanoid = character:FindFirstChild("Humanoid")
        rootPart = character:FindFirstChild("HumanoidRootPart")
        return true
    end
    return false
end

-- Fun√ß√£o para verificar se √© uma Esfera do Drag√£o
local function isDragonBall(model)
    -- Verifica se o nome come√ßa com { e termina com } (GUID)
    local name = tostring(model.Name)
    if string.sub(name, 1, 1) == "{" and string.sub(name, -1) == "}" then
        -- Verifica se tem apar√™ncia de esfera (partes redondas, brilho, etc)
        for _, child in pairs(model:GetChildren()) do
            if child:IsA("Part") then
                if child.Shape == Enum.PartType.Ball or child.Name:lower():find("sphere") or child.Name:lower():find("ball") then
                    return true
                end
            end
        end
    end
    return false
end

-- Fun√ß√£o para criar ESP de uma Esfera do Drag√£o
local function createDragonBallESP(dragonBall)
    if espHandles[dragonBall] then return end
    
    local rootPart = dragonBall:FindFirstChild("HumanoidRootPart") or dragonBall:FindFirstChild("Head") or dragonBall:FindFirstChild("Torso")
    if not rootPart then return end
    
    -- BillboardGui para texto flutuante
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "DragonBallESP"
    billboard.Adornee = rootPart
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = rootPart
    
    -- Texto da esfera
    local textLabel = Instance.new("TextLabel")
    textLabel.Text = "üåü ESFERA DO DRAG√ÉO"
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 1, 0)
    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    textLabel.TextStrokeTransparency = 0
    textLabel.TextScaled = true
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.Parent = billboard
    
    -- Highlight para brilho
    local highlight = Instance.new("Highlight")
    highlight.Name = "DragonBallHighlight"
    highlight.Adornee = dragonBall
    highlight.FillColor = Color3.new(1, 1, 0)
    highlight.OutlineColor = Color3.new(1, 0.5, 0)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.Parent = dragonBall
    
    espHandles[dragonBall] = {
        Billboard = billboard,
        Highlight = highlight
    }
end

-- Fun√ß√£o para remover ESP de uma Esfera
local function removeDragonBallESP(dragonBall)
    if espHandles[dragonBall] then
        if espHandles[dragonBall].Billboard then
            espHandles[dragonBall].Billboard:Destroy()
        end
        if espHandles[dragonBall].Highlight then
            espHandles[dragonBall].Highlight:Destroy()
        end
        espHandles[dragonBall] = nil
    end
end

-- Fun√ß√£o para limpar todos os ESPs
local function clearAllESP()
    for dragonBall, handles in pairs(espHandles) do
        removeDragonBallESP(dragonBall)
    end
    espHandles = {}
end

-- Fun√ß√£o para encontrar Esferas do Drag√£o
local function findDragonBalls()
    dragonBalls = {}
    
    if not updateCharacterReferences() then return 0 end
    
    -- Procurar em v√°rias localiza√ß√µes
    local possibleLocations = {
        Workspace:FindFirstChild("Map"),
        Workspace:FindFirstChild("Items"),
        Workspace:FindFirstChild("DragonBalls"),
        Workspace
    }
    
    for _, location in pairs(possibleLocations) do
        if location then
            for _, obj in pairs(location:GetDescendants()) do
                if obj:IsA("Model") and isDragonBall(obj) then
                    local rootPartBall = obj:FindFirstChild("HumanoidRootPart") or obj:FindFirstChild("Head") or obj:FindFirstChild("Torso")
                    
                    if rootPartBall then
                        local distance = (rootPartBall.Position - rootPart.Position).Magnitude
                        
                        table.insert(dragonBalls, {
                            Model = obj,
                            RootPart = rootPartBall,
                            Position = rootPartBall.Position,
                            Distance = distance
                        })
                    end
                end
            end
        end
    end
    
    -- Ordenar por dist√¢ncia
    table.sort(dragonBalls, function(a, b)
        return a.Distance < b.Distance
    end)
    
    local count = #dragonBalls
    espInfoLabel.Text = "üåü Esferas: " .. count
    
    -- Criar/atualizar ESP se estiver ativo
    if IS_ESP_ACTIVE then
        for _, dragonBall in pairs(dragonBalls) do
            createDragonBallESP(dragonBall.Model)
        end
    end
    
    return count
end

-- Fun√ß√£o para coletar Esferas do Drag√£o
local function collectDragonBalls()
    if not updateCharacterReferences() then return end
    
    local found = findDragonBalls()
    
    if found > 0 then
        statusLabel.Text = "üíé COLETANDO ESFERAS..."
        statusLabel.TextColor3 = Color3.new(1, 1, 0)
        
        for _, dragonBall in pairs(dragonBalls) do
            if not IS_FARMING then break end
            
            -- Teleportar para a esfera
            local teleportPosition = dragonBall.Position + Vector3.new(0, 2, 0)
            rootPart.CFrame = CFrame.new(teleportPosition)
            
            -- Esperar um pouco para coleta autom√°tica
            wait(0.5)
            
            -- Verificar se a esfera ainda existe
            if not dragonBall.Model or not dragonBall.Model.Parent then
                espInfoLabel.Text = "üåü Esferas: " .. (#dragonBalls - 1)
            end
            
            RunService.Heartbeat:Wait()
        end
        
        statusLabel.Text = "üíé COLETA CONCLU√çDA"
    else
        statusLabel.Text = "üíé NENHUMA ESFERA ENCONTRADA"
    end
end

-- Fun√ß√£o para encontrar TODOS os NPCs alvo
local function findTargetNPCs()
    targetNPCs = {}
    
    if not updateCharacterReferences() then
        infoLabel.Text = "‚ùå Personagem n√£o carregado"
        return 0
    end
    
    -- Procurar em v√°rias localiza√ß√µes poss√≠veis
    local possibleLocations = {
        Workspace:FindFirstChild("Map"),
        Workspace:FindFirstChild("NPCs"),
        Workspace:FindFirstChild("Enemies"),
        Workspace
    }
    
    for _, location in pairs(possibleLocations) do
        if location then
            -- Procurar por todos os NPCs alvo
            for _, npcName in pairs(NPC_TARGETS) do
                for _, obj in pairs(location:GetDescendants()) do
                    if obj:IsA("Model") and string.lower(obj.Name) == string.lower(npcName) then
                        local rootPartNPC = obj:FindFirstChild("HumanoidRootPart") or obj:FindFirstChild("Head") or obj:FindFirstChild("Torso")
                        local humanoidNPC = obj:FindFirstChildOfClass("Humanoid")
                        
                        if rootPartNPC and humanoidNPC and humanoidNPC.Health > 0 then
                            local distance = (rootPartNPC.Position - rootPart.Position).Magnitude
                            
                            if distance <= FARM_RANGE then
                                table.insert(targetNPCs, {
                                    Model = obj,
                                    RootPart = rootPartNPC,
                                    Humanoid = humanoidNPC,
                                    Position = rootPartNPC.Position,
                                    Distance = distance,
                                    Name = obj.Name
                                })
                            end
                        end
                    end
                end
            end
        end
    end
    
    -- Ordenar por dist√¢ncia (mais pr√≥ximo primeiro)
    table.sort(targetNPCs, function(a, b)
        return a.Distance < b.Distance
    end)
    
    local count = #targetNPCs
    if count > 0 then
        infoLabel.Text = "NPCs: " .. count .. " | " .. targetNPCs[1].Name .. " | Dist: " .. math.floor(targetNPCs[1].Distance)
    else
        infoLabel.Text = "NPCs: 0 | Nenhum encontrado"
    end
    return count
end

-- Fun√ß√£o para teleportar
local function teleportCloseToNPC(targetPosition, targetRootPart)
    if not rootPart or not targetRootPart then 
        if not updateCharacterReferences() then return false end
    end
    
    -- Verificar se o alvo ainda existe
    if not targetRootPart or not targetRootPart.Parent then
        return false
    end
    
    -- Calcular posi√ß√£o BEM perto do NPC
    local direction = (targetPosition - rootPart.Position).Unit
    local teleportPosition = targetPosition - (direction * ATTACK_RANGE)
    teleportPosition = Vector3.new(teleportPosition.X, targetPosition.Y + TELEPORT_OFFSET, teleportPosition.Z)
    
    -- Teleportar usando Tween para ser mais suave
    local tweenInfo = TweenInfo.new(0.1, Enum.EasingStyle.Linear)
    local tween = TweenService:Create(rootPart, tweenInfo, {CFrame = CFrame.new(teleportPosition, targetPosition)})
    tween:Play()
    
    wait(0.15)
    
    return true
end

-- Sistema de ataque APENAS com E
local function performAttack()
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
        wait(0.03)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
    end)
end

-- Fun√ß√£o para verificar se o alvo √© v√°lido
local function isTargetValid(target)
    if not target or not target.Model then return false end
    if not target.Model.Parent then return false end
    
    local humanoid = target.Model:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return false end
    
    local rootPartNPC = target.Model:FindFirstChild("HumanoidRootPart") or target.Model:FindFirstChild("Head")
    if not rootPartNPC then return false end
    
    return true
end

-- Loop principal de farm
local function farmLoop()
    while IS_FARMING do
        if not updateCharacterReferences() then
            statusLabel.Text = "üü° AGUARDANDO PERSONAGEM..."
            wait(1)
            continue
        end
        
        local found = findTargetNPCs()
        
        if found > 0 then
            currentTarget = targetNPCs[1]
            
            if isTargetValid(currentTarget) then
                statusLabel.Text = "üü¢ ATACANDO " .. currentTarget.Name:upper()
                statusLabel.TextColor3 = Color3.new(0.5, 1, 0.5)
                infoLabel.Text = "NPCs: " .. found .. " | " .. currentTarget.Name .. " | Sa√∫de: " .. math.floor(currentTarget.Humanoid.Health)
                
                -- Teleportar para perto do NPC
                local teleportSuccess = teleportCloseToNPC(currentTarget.Position, currentTarget.RootPart)
                
                if teleportSuccess then
                    -- Spam de ataques R√ÅPIDOS apenas com E
                    for i = 1, 10 do
                        if not IS_FARMING then break end
                        if not isTargetValid(currentTarget) then break end
                        
                        performAttack()
                        
                        -- Virar para o alvo continuamente
                        if rootPart and currentTarget.RootPart then
                            rootPart.CFrame = CFrame.new(rootPart.Position, currentTarget.RootPart.Position)
                        end
                        
                        RunService.Heartbeat:Wait()
                    end
                else
                    statusLabel.Text = "üî¥ FALHA NO TELEPORTE"
                    wait(0.5)
                end
                
            else
                statusLabel.Text = "üü° " .. currentTarget.Name:upper() .. " MORTO"
                statusLabel.TextColor3 = Color3.new(1, 1, 0.5)
                targetNPCs = {}
                wait(0.5)
            end
            
        else
            statusLabel.Text = "üü° PROCURANDO NPCs..."
            statusLabel.TextColor3 = Color3.new(1, 1, 0.5)
            wait(0.5)
        end
        
        RunService.Heartbeat:Wait()
    end
end

-- Loop do ESP
local function espLoop()
    while IS_ESP_ACTIVE do
        findDragonBalls()
        wait(2) -- Atualizar a cada 2 segundos
    end
end

-- Conectar bot√µes
toggleButton.MouseButton1Click:Connect(function()
    IS_FARMING = not IS_FARMING
    
    if IS_FARMING then
        toggleButton.Text = "‚èπ PARAR FARM"
        toggleButton.BackgroundColor3 = Color3.fromRGB(180, 80, 80)
        statusLabel.Text = "üü¢ INICIANDO FARM..."
        statusLabel.TextColor3 = Color3.new(0.5, 1, 0.5)
        
        coroutine.wrap(farmLoop)()
        
    else
        toggleButton.Text = "‚ñ∂ INICIAR FARM"
        toggleButton.BackgroundColor3 = Color3.fromRGB(80, 180, 80)
        statusLabel.Text = "üî¥ PARADO"
        statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
        currentTarget = nil
    end
end)

searchButton.MouseButton1Click:Connect(function()
    local count = findTargetNPCs()
    statusLabel.Text = "üîç NPCs ENCONTRADOS: " .. count
    statusLabel.TextColor3 = Color3.new(0.8, 0.8, 1)
    wait(1.5)
    if not IS_FARMING then
        statusLabel.Text = "üî¥ PARADO"
        statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
    end
end)

espButton.MouseButton1Click:Connect(function()
    IS_ESP_ACTIVE = not IS_ESP_ACTIVE
    
    if IS_ESP_ACTIVE then
        espButton.Text = "üåü DESLIGAR ESP"
        espButton.BackgroundColor3 = Color3.fromRGB(80, 180, 180)
        statusLabel.Text = "üåü ESP ESFERAS ATIVADO"
        statusLabel.TextColor3 = Color3.new(1, 1, 0)
        
        -- Encontrar e criar ESP para esferas existentes
        findDragonBalls()
        coroutine.wrap(espLoop)()
        
    else
        espButton.Text = "üåü LIGAR ESP"
        espButton.BackgroundColor3 = Color3.fromRGB(180, 80, 180)
        statusLabel.Text = "üåü ESP ESFERAS DESATIVADO"
        statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
        
        -- Limpar todos os ESPs
        clearAllESP()
    end
end)

collectButton.MouseButton1Click:Connect(function()
    if IS_FARMING then
        statusLabel.Text = "‚ùå PARE O FARM PRIMEIRO"
        statusLabel.TextColor3 = Color3.new(1, 0, 0)
        wait(2)
        if IS_FARMING then
            statusLabel.Text = "üü¢ ATACANDO NPC"
        else
            statusLabel.Text = "üî¥ PARADO"
        end
    else
        coroutine.wrap(collectDragonBalls)()
    end
end)

-- Sistema de respawn autom√°tico
player.CharacterAdded:Connect(function(newChar)
    wait(2)
    updateCharacterReferences()
    
    if IS_FARMING then
        statusLabel.Text = "üü¢ RETOMANDO FARM AP√ìS RESPAWN..."
        wait(1)
        coroutine.wrap(farmLoop)()
    end
    
    -- Recriar ESP se estiver ativo
    if IS_ESP_ACTIVE then
        wait(3)
        findDragonBalls()
    end
end)

-- Inicializa√ß√£o
print("üêâ Auto Farm DBR + ESP Esferas do Drag√£o!")
print("üéØ Farm: Tennenman, Goku e Carl")
print("üåü ESP para Esferas do Drag√£o (GUID)")
print("üíé Coleta autom√°tica de esferas")

-- Primeira busca
findTargetNPCs()
findDragonBalls()